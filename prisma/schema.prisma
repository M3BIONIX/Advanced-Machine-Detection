generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  emailVerified  Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  calls          Call[]
  accounts       Account[]
  sessions       Session[]
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  providerId        String
  accountId         String
  password          String?
  accessToken       String?
  refreshToken      String?
  scope             String?
  expiresAt         Int?
  tokenType         String?
  idToken           String?
  sessionState      String?
  raw               Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id])

  @@unique([providerId, accountId])
}

model Session {
  id                 String   @id @default(cuid())
  userId             String
  expiresAt          DateTime
  token              String   @unique
  antiCsrfToken      String?
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user               User     @relation(fields: [userId], references: [id])
}

model VerificationToken {
  id          String   @id @default(cuid())
  identifier  String
  token       String   @unique
  expires     DateTime
  createdAt   DateTime @default(now())

  @@unique([identifier, token])
}

model RateLimit {
  key         String   @id
  count       Int      @default(0)
  lastRequest BigInt   @default(0)
}

model Call {
  id            String   @id @default(cuid())
  callSid       String   @unique
  userId        String
  user          User     @relation(fields: [userId], references: [id])

  toNumber      String
  fromNumber    String

  amdStrategy   String
  amdResult     String?
  amdConfidence Float?
  detectedAt    DateTime?

  status        String
  duration      Int?
  cost          Float?
  callStartedAt DateTime?
  callEndedAt   DateTime?

  errorMessage  String?
  rawAmdPayload Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  amdEvents     AmdEvent[]

  @@index([userId])
  @@index([amdStrategy])
  @@index([status])
}

model AmdEvent {
  id          String   @id @default(cuid())
  callId      String
  call        Call     @relation(fields: [callId], references: [id])

  eventType   String
  timestamp   DateTime @default(now())
  confidence  Float?
  metadata    Json?

  @@index([callId, timestamp])
}
